name: éƒ¨ç½²ï¼ˆCloudflare Workers + Assetsï¼‰

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      ADMIN_PATH: ${{ secrets.ADMIN_PATH }}
      WORKER_NAME: dundun-watch
      KV_TITLE: dundun-watch_MONITOR_DATA
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Node çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£… Wrangler
        run: |
          echo "å®‰è£… Wrangler CLI..."
          npm i -g wrangler@latest

      - name: å‘çŽ° Cloudflare è´¦æˆ· ID
        shell: bash
        run: |
          set -e
          echo "å¼€å§‹å‘çŽ° Cloudflare è´¦æˆ· ID..."
          ACC_JSON=$(curl -s -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" -H "Content-Type: application/json" https://api.cloudflare.com/client/v4/accounts)
          ACCOUNT_ID=$(echo "$ACC_JSON" | node -e "let d='';process.stdin.on('data',c=>d+=c);process.stdin.on('end',()=>{try{const o=JSON.parse(d);console.log(o.result?.[0]?.id||'');}catch(e){console.log('');}})")
          if [ -z "$ACCOUNT_ID" ]; then echo 'Failed to discover Account ID'; exit 1; fi
          echo "CLOUDFLARE_ACCOUNT_ID=$ACCOUNT_ID" >> $GITHUB_ENV

      - name: åˆ›å»ºæˆ–å¤ç”¨ KV å‘½åç©ºé—´
        shell: bash
        run: |
          set -e
          echo "åˆ›å»ºæˆ–å¤ç”¨ KV å‘½åç©ºé—´ï¼š$KV_TITLE"
          CREATE_JSON=$(curl -s -X POST "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/storage/kv/namespaces" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data "{\"title\": \"$KV_TITLE\"}") || true
          KV_NAMESPACE_ID=$(echo "$CREATE_JSON" | node -e "let d='';process.stdin.on('data',c=>d+=c);process.stdin.on('end',()=>{try{const o=JSON.parse(d);if(o?.success&&o?.result?.id)console.log(o.result.id);else console.log('');}catch(e){console.log('');}})")
          if [ -z "$KV_NAMESPACE_ID" ]; then
            LIST_JSON=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/storage/kv/namespaces?per_page=100" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" -H "Content-Type: application/json")
            KV_NAMESPACE_ID=$(echo "$LIST_JSON" | node -e "let d='';process.stdin.on('data',c=>d+=c);process.stdin.on('end',()=>{try{const o=JSON.parse(d);const arr=o?.result||[];const f=arr.find(x=>x?.title==='${KV_TITLE}');console.log(f?f.id:'');}catch(e){console.log('');}})")
          fi
          if [ -z "$KV_NAMESPACE_ID" ]; then
            echo 'Failed to get KV namespace id' >&2
            exit 1
          fi
          echo "KV_NAMESPACE_ID=$KV_NAMESPACE_ID" >> $GITHUB_ENV

      - name: å†™å…¥ç®¡ç†å‘˜å¯†ç å’ŒåŽå°è·¯å¾„åˆ° KV
        env:
          ADMIN_PASSWORD: ${{ env.ADMIN_PASSWORD }}
          ADMIN_PATH: ${{ env.ADMIN_PATH }}
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}
          KV_NAMESPACE_ID: ${{ env.KV_NAMESPACE_ID }}
        run: |
          echo "å†™å…¥ç®¡ç†å‘˜å¯†ç åˆ° KV..."
          ADMIN_PW=${ADMIN_PASSWORD:-admin123456}
          wrangler kv:key put --namespace-id $KV_NAMESPACE_ID admin_password "$ADMIN_PW"
          echo "å†™å…¥åŽå°è·¯å¾„åˆ° KV..."
          ADMIN_PATH_VALUE=${ADMIN_PATH:-admin}
          wrangler kv:key put --namespace-id $KV_NAMESPACE_ID admin_path "$ADMIN_PATH_VALUE"

      - name: æž„å»ºå‰ç«¯
        run: |
          echo "å¼€å§‹æž„å»ºå‰ç«¯..."
          cd frontend
          npm ci
          npm run build

      - name: ç”Ÿæˆä¸´æ—¶ wrangler é…ç½®
        shell: bash
        run: |
          echo "ç”Ÿæˆä¸´æ—¶ wrangler é…ç½®..."
          cat > wrangler.ci.toml <<'EOF'
name = "dundun-watch"
main = "src/index.js"
compatibility_date = "2024-12-08"

[assets]
directory = "./frontend/dist"
binding = "ASSETS"
html_handling = "auto-trailing-slash"
not_found_handling = "single-page-application"

[triggers]
crons = ["* * * * *", "0 4 * * *"]
EOF
          echo "" >> wrangler.ci.toml
          echo "[[kv_namespaces]]" >> wrangler.ci.toml
          echo "binding = \"MONITOR_DATA\"" >> wrangler.ci.toml
          echo "id = \"${KV_NAMESPACE_ID}\"" >> wrangler.ci.toml

      - name: éƒ¨ç½² Worker + Assets
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "å¼€å§‹éƒ¨ç½² Worker + Assets..."
          wrangler deploy --config wrangler.ci.toml

      - name: èŽ·å– Worker åŸŸå
        run: |
          WORKER_URL="https://${WORKER_NAME}.${CLOUDFLARE_ACCOUNT_ID}.workers.dev"
          echo "WORKER_URL=$WORKER_URL" >> $GITHUB_ENV

      - name: éƒ¨ç½²æˆåŠŸæ‘˜è¦
        if: success()
        run: |
          echo "## ðŸŽ‰ éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è®¿é—®åœ°å€ï¼š** $WORKER_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ADMIN_PATH_DISPLAY="${ADMIN_PATH:-admin}"
          echo "- ðŸ  é¦–é¡µï¼š$WORKER_URL" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” åŽå°ï¼š$WORKER_URL/$ADMIN_PATH_DISPLAY" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”‘ å¯†ç ï¼šadmin123456ï¼ˆå¦‚å·²é…ç½® ADMIN_PASSWORD åˆ™ä½¿ç”¨ä½ è®¾ç½®çš„å¯†ç ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æž¶æž„è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… å·²åˆå¹¶ä¸ºå•ä¸€ Worker" >> $GITHUB_STEP_SUMMARY
          echo "- å‰ç«¯é™æ€èµ„æºï¼šWorkers Assets" >> $GITHUB_STEP_SUMMARY
          echo "- API æŽ¥å£ï¼šWorker å¤„ç†" >> $GITHUB_STEP_SUMMARY
          echo "- å®šæ—¶ç›‘æŽ§ï¼šWorker Cron" >> $GITHUB_STEP_SUMMARY
          echo "- æ•°æ®å­˜å‚¨ï¼šWorkers KV" >> $GITHUB_STEP_SUMMARY

      - name: éƒ¨ç½²å¤±è´¥æç¤º
        if: failure()
        run: |
          echo "## âŒ éƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "1. CLOUDFLARE_API_TOKEN æ˜¯å¦æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
          echo "2. å‰ç«¯æž„å»ºæ˜¯å¦æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "3. æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯" >> $GITHUB_STEP_SUMMARY
