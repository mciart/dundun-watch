name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '20'

jobs:
  # æ„å»ºå¹¶éƒ¨ç½²
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd frontend && npm ci

      - name: Build frontend
        run: npm run build:frontend

      - name: Configure D1 Database ID
        env:
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
        run: |
          if [ -z "$D1_DATABASE_ID" ]; then
            echo "âŒ é”™è¯¯ï¼šD1_DATABASE_ID æœªé…ç½®"
            exit 1
          fi
          
          echo "âœ… é…ç½® D1 Database ID: $D1_DATABASE_ID"
          sed -i "s/YOUR_D1_DATABASE_ID/$D1_DATABASE_ID/g" wrangler.toml

      - name: Get Cloudflare Account ID
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ğŸ” è·å– Account ID..."
          ACCOUNT_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts?per_page=1" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" | jq -r '.result[0].id')
          
          if [ -z "$ACCOUNT_ID" ] || [ "$ACCOUNT_ID" = "null" ]; then
             echo "âŒ æ— æ³•è·å– Account IDï¼Œè¯·æ£€æŸ¥ API Token æƒé™"
             exit 1
          fi
          
          echo "âœ… è·å–åˆ° Account ID: $ACCOUNT_ID"
          echo "CLOUDFLARE_ACCOUNT_ID=$ACCOUNT_ID" >> $GITHUB_ENV

      - name: Check Wrangler Auth
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: npx wrangler whoami

      - name: Initialize D1 Schema
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ğŸ“¦ åˆå§‹åŒ– D1 æ•°æ®åº“..."
          npx wrangler d1 execute dundun-sentinel-db --file=./schema.sql --remote --yes || echo "âš ï¸ Schema åˆå§‹åŒ–å¤±è´¥ï¼ˆå¯èƒ½å·²å­˜åœ¨ï¼‰ï¼Œç»§ç»­éƒ¨ç½²..."

      - name: Run D1 Migrations
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ğŸ”„ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
          # æ·»åŠ æ–°åˆ—ï¼ˆå¦‚æœå·²å­˜åœ¨ä¼šæŠ¥é”™ä½†ä¸å½±å“éƒ¨ç½²ï¼‰
          npx wrangler d1 execute dundun-sentinel-db --command "ALTER TABLE sites ADD COLUMN tcp_host TEXT;" --remote --yes 2>/dev/null || true
          npx wrangler d1 execute dundun-sentinel-db --command "ALTER TABLE incidents ADD COLUMN type TEXT DEFAULT 'down';" --remote --yes 2>/dev/null || true
          echo "âœ… è¿ç§»æ£€æŸ¥å®Œæˆ"

      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
          npx wrangler deploy

      - name: Deployment Success
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo ""
          echo "ğŸ“ åç»­æ­¥éª¤ï¼š"
          echo "1. è®¿é—®ä½ çš„ Worker URL"
          echo "2. é»˜è®¤åå°è·¯å¾„: /admin"
          echo "3. é»˜è®¤å¯†ç : admin"
          echo "4. è¯·ç«‹å³ç™»å½•åå°ä¿®æ”¹é»˜è®¤å¯†ç ï¼"
