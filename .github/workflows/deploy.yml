name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '20'

jobs:
  # æ„å»ºå¹¶éƒ¨ç½²
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd frontend && npm ci

      - name: Build frontend
        run: npm run build:frontend

      - name: Configure D1 Database ID
        env:
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
        run: |
          if [ -z "$D1_DATABASE_ID" ]; then
            echo "âŒ é”™è¯¯ï¼šD1_DATABASE_ID æœªé…ç½®"
            echo ""
            echo "è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤é…ç½®ï¼š"
            echo "1. ç™»å½• Cloudflare Dashboard"
            echo "2. è¿›å…¥ Workers & Pages â†’ D1 SQL Database"
            echo "3. åˆ›å»ºæ•°æ®åº“ï¼Œåç§°ä¸º dundun-sentinel-db"
            echo "4. å¤åˆ¶æ•°æ®åº“ ID"
            echo "5. åœ¨ GitHub ä»“åº“ Settings â†’ Secrets â†’ Actions æ·»åŠ  D1_DATABASE_ID"
            exit 1
          fi
          
          echo "âœ… é…ç½® D1 Database ID..."
          sed -i "s/YOUR_D1_DATABASE_ID/$D1_DATABASE_ID/g" wrangler.toml

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Deployment Success
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo ""
          echo "ğŸ“ åç»­æ­¥éª¤ï¼š"
          echo "1. è®¿é—®ä½ çš„ Worker URL"
          echo "2. é»˜è®¤åå°è·¯å¾„: /admin"
          echo "3. é»˜è®¤å¯†ç : admin"
          echo "4. è¯·ç«‹å³ç™»å½•åå°ä¿®æ”¹é»˜è®¤å¯†ç ï¼"
